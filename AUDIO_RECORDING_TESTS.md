# 📱 音声録音割り込み処理テスト項目

## 概要
このドキュメントは、VoiLogアプリの音声録音機能における割り込み処理のテスト項目をまとめたものです。
アラーム、電話、通知などの割り込みが発生しても録音が継続されることを確認するためのテストケースを記載しています。

## 🔧 基本機能テスト

### ✅ 録音開始・停止
- [ ] 録音開始が正常に動作する
- [ ] 録音停止が正常に動作する
- [ ] 録音一時停止・再開が正常に動作する
- [ ] 2秒未満の録音で停止処理がスキップされる

### ✅ AVAudioSession設定
- [ ] `.duckOthers`オプションが正しく設定される
- [ ] `.mixWithOthers`オプションが正しく設定される
- [ ] Bluetoothオプションが正しく設定される
- [ ] サンプリングレートが正しく設定される

## 🚨 割り込み処理テスト

### ✅ アラーム・タイマー割り込み

#### アラーム割り込み
**手順:**
1. アプリで録音を開始
2. 時計アプリでアラームを1分後に設定
3. アラームが鳴ったときの録音状態を確認
4. アラームを止めた後の録音状態を確認

**確認項目:**
- [ ] アラーム鳴動中も録音が継続される
- [ ] アラーム音が録音に混入するが音量が小さい（duckOthers効果）
- [ ] アラーム停止後も録音が継続される
- [ ] 録音時間が正常にカウントされる
- [ ] アプリがクラッシュしない

#### タイマー割り込み
**手順:**
1. アプリで録音を開始
2. 時計アプリでタイマーを30秒に設定
3. タイマー音が鳴ったときの録音状態を確認
4. タイマーを止めた後の録音状態を確認

**確認項目:**
- [ ] タイマー鳴動中も録音が継続される
- [ ] タイマー音量が小さくなる（duckOthers効果）
- [ ] タイマー停止後も録音が継続される

### ✅ 通知音割り込み

#### システム通知
**手順:**
1. アプリで録音を開始
2. 設定→通知→メッセージで通知音を有効にする
3. 別の端末からSMSを送信
4. 通知音が鳴ったときの録音状態を確認

**確認項目:**
- [ ] 通知音鳴動中も録音が継続される
- [ ] 通知音が小さくなる（duckOthers効果）
- [ ] 複数の通知が来ても録音が継続される
- [ ] 通知音終了後、録音が正常に継続される

#### アプリ通知
**手順:**
1. アプリで録音を開始
2. 他のアプリ（LINE、Twitter等）の通知を発生させる
3. 通知音が鳴ったときの録音状態を確認

### ✅ 電話割り込み

#### 着信割り込み
**手順:**
1. アプリで録音を開始
2. 別の端末から電話をかける
3. 着信時の録音状態を確認
4. 電話に出る/切るときの録音状態を確認
5. 通話終了後の録音状態を確認

**確認項目:**
- [ ] 着信時に録音が一時停止される
- [ ] 通話終了後に録音が自動再開される
- [ ] アプリがクラッシュしない
- [ ] 録音データに欠損がない

#### 発信割り込み
**手順:**
1. アプリで録音を開始
2. 電話アプリから発信する
3. 発信時の録音状態を確認
4. 通話終了後の録音状態を確認

### ✅ Siri割り込み
**手順:**
1. アプリで録音を開始
2. 「Hey Siri」または電源ボタン長押しでSiriを起動
3. Siri使用中の録音状態を確認
4. Siri終了後の録音状態を確認

**確認項目:**
- [ ] Siri起動時の録音状態
- [ ] Siri終了後の録音復旧
- [ ] アプリがクラッシュしない

## 🎧 オーディオデバイス変更テスト

### ✅ Bluetoothヘッドセット

#### AirPods接続/切断
**手順:**
1. AirPodsをペアリングしておく
2. アプリで録音を開始
3. 録音中にAirPodsを接続する
4. 録音状態と音質を確認
5. 録音中にAirPodsを切断する
6. 録音状態と音質を確認

**確認項目:**
- [ ] 接続時も録音が継続される
- [ ] 切断時も録音が継続される
- [ ] 音質に大きな変化がない
- [ ] アプリがクラッシュしない
- [ ] デバイス変更時の音質に問題がない

#### Bluetoothスピーカー
**手順:**
1. Bluetoothスピーカーをペアリング
2. アプリで録音を開始
3. 録音中にスピーカーを接続/切断
4. 録音状態を確認

### ✅ 有線ヘッドセット

#### 有線ヘッドフォン接続/切断
**手順:**
1. アプリで録音を開始
2. 録音中に有線ヘッドフォンを接続
3. 録音状態を確認
4. 録音中に有線ヘッドフォンを抜く
5. 録音状態を確認

**確認項目:**
- [ ] 有線ヘッドセット接続時も録音が継続される
- [ ] 有線ヘッドセット切断時も録音が継続される
- [ ] マイク付きヘッドセットの切り替えに対応

### ✅ スピーカー切り替え
- [ ] 内蔵スピーカー⇔外部スピーカー切り替えに対応
- [ ] AirPodsなどの切り替えに対応

## 📱 アプリライフサイクルテスト

### ✅ バックグラウンド処理

#### バックグラウンド移行
**手順:**
1. アプリで録音を開始
2. ホームボタンを押してアプリをバックグラウンドに移行
3. 他のアプリを使用
4. 録音アプリに戻る
5. 録音状態を確認

**確認項目:**
- [ ] アプリがバックグラウンドに移行しても録音継続
- [ ] バックグラウンドタスクが適切に管理される
- [ ] フォアグラウンド復帰時の状態が正常

#### アプリスイッチャー
**手順:**
1. アプリで録音を開始
2. アプリスイッチャーを開く
3. 他のアプリに切り替える
4. 録音アプリに戻る
5. 録音状態を確認

#### コントロールセンター
**手順:**
1. アプリで録音を開始
2. コントロールセンターを開く
3. 音楽再生/停止、音量調整などを操作
4. 録音状態を確認

### ✅ メモリ警告
- [ ] メモリ警告時も録音が継続される
- [ ] メモリ警告時の適切なリソース管理

## 🔋 システム状態テスト

### ✅ 低バッテリー警告
**手順:**
1. バッテリーを20%以下にする
2. アプリで録音を開始
3. 低バッテリー警告が表示されたときの録音状態を確認

### ✅ 充電開始/終了
**手順:**
1. アプリで録音を開始
2. 録音中に充電ケーブルを接続
3. 録音状態を確認
4. 録音中に充電ケーブルを抜く
5. 録音状態を確認

## 🎵 他アプリとの同時使用テスト

### ✅ 音楽アプリとの併用
**手順:**
1. Apple Music/Spotifyで音楽を再生
2. アプリで録音を開始
3. 録音状態と音楽再生状態を確認
4. 音楽を停止/再開して録音への影響を確認

### ✅ 動画アプリとの併用
**手順:**
1. YouTube/NetflixでBGM付き動画を再生
2. アプリで録音を開始
3. 録音状態と動画再生状態を確認

## 🛡️ エラーハンドリングテスト

### ✅ クラッシュ防止
- [ ] 割り込み処理中にクラッシュしない
- [ ] 複数の割り込みが同時発生してもクラッシュしない
- [ ] 不正な状態でのメソッド呼び出しでクラッシュしない
- [ ] メモリリークが発生しない

### ✅ 状態管理
- [ ] `isRecording`フラグが正しく管理される
- [ ] `isPaused`フラグが正しく管理される
- [ ] NotificationObserverが適切に削除される
- [ ] AudioEngineの状態が正しく管理される

### ✅ エラー復旧
- [ ] AudioSession再アクティブ化失敗時の処理
- [ ] AudioEngine再開失敗時の処理
- [ ] 予期しないエラー時の適切なログ出力

## 🔄 連続操作テスト

### ✅ 短時間での録音開始/停止
**手順:**
1. 録音開始→即座に停止を10回繰り返す
2. 各操作でアプリの動作を確認
3. メモリリークやクラッシュがないか確認

### ✅ 長時間録音
**手順:**
1. 30分以上の長時間録音を開始
2. 録音中に上記の各種割り込みテストを実行
3. 録音データの整合性を確認

## 🧪 ストレステスト

### ✅ 連続割り込み
- [ ] 短時間に複数の割り込みが発生しても正常動作
- [ ] 長時間の録音中の割り込み処理
- [ ] 割り込み中にアプリ操作しても正常動作

### ✅ 極端なケース
- [ ] 録音開始直後の割り込み
- [ ] 録音終了直前の割り込み
- [ ] 非常に短い割り込み（瞬間的な通知音など）

## 🔊 音質・パフォーマンステスト

### ✅ 録音品質
- [ ] 割り込み前後で音質に変化がない
- [ ] 音声データに欠損やノイズがない
- [ ] サンプリングレートが維持される
- [ ] 音量レベルが適切に記録される

### ✅ パフォーマンス
- [ ] 割り込み処理がCPU使用率に影響しない
- [ ] メモリ使用量が適切に管理される
- [ ] バッテリー消費が過度でない

## 📊 ログ・デバッグテスト

### ✅ ログ出力
- [ ] 割り込み開始時のログが正しく出力される
- [ ] 割り込み終了時のログが正しく出力される
- [ ] エラー時のログが適切に出力される
- [ ] デバッグ情報が十分に記録される

### ✅ 監視・分析
- [ ] Crashlyticsにクラッシュレポートが送信されない
- [ ] パフォーマンス指標が正常範囲内
- [ ] ユーザー体験に悪影響がない

## 🎯 優先度別テスト

### 🔴 高優先度（必須）
- アラーム・通知音での録音継続
- クラッシュ防止
- 基本的な録音機能
- 電話割り込み後の自動復旧

### 🟡 中優先度（重要）
- Bluetoothデバイス変更対応
- Siri使用後の録音復旧
- バックグラウンド動作
- エラー復旧処理

### 🟢 低優先度（推奨）
- ストレステスト
- 詳細なログ分析
- パフォーマンス最適化
- 他アプリとの併用

## 📝 テスト記録フォーマット

```
テスト日時: ____年__月__日 __:__
端末: iPhone __ (iOS __.__)
アプリバージョン: __.__.__
テスター: ________

【テスト項目】: 
【結果】: ✅成功 / ❌失敗
【詳細】: 
【問題点】: 
【再現手順】: 
【備考】: 
```

## 🔗 関連ドキュメント

- [README.md](./README.md) - プロジェクト概要
- [AudioRecoder.swift](./VoiLog/AudioRecoder.swift) - 録音処理実装

## 📞 問題報告

テスト中に問題を発見した場合は、以下の情報を含めて報告してください：

1. 発生した問題の詳細
2. 再現手順
3. 使用端末とiOSバージョン
4. アプリバージョン
5. ログ情報（可能であれば）

---

**最終更新日**: 2024年12月19日 